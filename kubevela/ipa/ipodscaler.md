# 弹性伸缩ipodscaler
##功能描述
针对行内弹性伸缩的场景努力提供智能弹性伸缩能力，主要支持以下功能：
- 1、支持pod的纵向扩缩容，即replicas，伸缩时间 `<=2min`；指标包括cpu、mem
- 2、支持pod的横向扩缩容，即cpu/mem，伸缩时间 `<=2min`；
- 3、支持定时的纵向扩缩容，支持时间段配置，且能够对调度时间段内的replicas进行保持；
- 4、支持预测驱动的智能扩缩容，结合时序预测算法对有明显规律的应用趋势进行预测，如周三5折，且支持不同应用配置不同的算法；
- 5、支持弹性伸缩的DryRun模式，DryRun模式下不会自动更改副本，用户可以预览计算的副本并自行控制副本，且切换模式能够运行时生效；

通过以上特性能够保证应用在安全承受业务流量的同时，能够快速、灵敏的进行**缩容**，提高云资源利用率。
**周总的图**


##设计思想
- 1、k8s的HPA已经发展到了v2beta2，且在不断演进的过程已经解决了很多通用的问题，尽量沿用HPA的经验；
- 2、不论是腾讯的crane还是微软/RedHat的KEDA，都是HPA作为弹性控制的执行层，在业务集群内通过更上层的控制层支持更丰富的弹性触发策略（社区将弹性伸缩看作一个类似于prometheus的基础设施），
，但是需要在每个业务集群中部署资源，我们更倾向于采用不侵入业务集群的架构，通过管理集群来控制层和执行层；

##待解决问题
- 1、同时使用scaler和ipodscaler时，VelaCore和ipodscaler会抢占控制副本数造成冲突，已经提了issue且解决思路已经和天元、殷达基本达成共识，还有具体实现需要和殷达联合开发。[apply-once policy](http://dwiki.cmbchina.cn/pages/viewpage.action?pageId=268445420)
- 2、Thanos和Flink需要降低指标发送延时，且变更交互方式`flink->kafka`方式为`flink->api`

##实现方案
# metrics
# Resource 支持pod里的所有系统资源，一般只会用cpu、mem, 因为不同语言都有内存池及内置的GC机制导致进程内存监控不准确。
# Pods 指cpu、mem之外的由pod自身提供的监控指标，qps等
# Object 指不由pod本身提供的，但是可以通过其他k8s资源获取的指标，比如汇聚关联的一个component下所有的资源的指标
# External 指本身跟k8s无关的自定义指标